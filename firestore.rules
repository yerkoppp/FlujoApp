rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    // --- Funciones de Ayuda ---
    
    function isAuth() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isAdmin() {
      return isAuth() && getUserData().role == 'ADMINISTRADOR';
    }
    
    function isWorker() {
       return isAuth() && getUserData().role == 'TRABAJADOR';
    }
    
    // --- Reglas por Colecci칩n ---
    
    match /users/{userId} {
      allow read: if isAuth();
      allow get: if isUser(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() || isUser(userId);
      allow delete: if isAdmin();
    }

    match /material_requests/{requestId} {
      allow read: if isAdmin() ||
                     (isWorker() && resource.data.workerId == request.auth.uid);
      allow list: if isAuth();
      allow create: if isWorker() &&
                       request.resource.data.workerId == request.auth.uid &&
                       request.resource.data.status == 'PENDIENTE' &&
                       request.resource.data.items is list &&
                       request.resource.data.items.size() > 0 &&
                       request.resource.data.warehouseId is string;
      allow update: if (isAdmin() &&
                         request.resource.data.workerId == resource.data.workerId &&
                         request.resource.data.items == resource.data.items &&
                         request.resource.data.warehouseId == resource.data.warehouseId)
                       ||
                       (isWorker() &&
                         resource.data.workerId == request.auth.uid &&
                         resource.data.status == 'PENDIENTE' &&
                         request.resource.data.status == 'CANCELADO' &&
                         request.resource.data.diff(resource.data).affectedKeys()
                           .hasOnly(['status']));
      allow delete: if false;
    }

    match /document_assignments/{assignmentId} {
      allow read: if request.auth != null;
      allow read: if isAdmin() ||
                     (isWorker() && resource.data.workerId == request.auth.uid);
      allow list: if isAuth();
      allow create: if isAdmin();
      allow update: if isAdmin() ||
                       (isWorker() &&
                        resource.data.workerId == request.auth.uid &&
                        resource.data.status == 'PENDIENTE' &&
                        request.resource.data.status == 'FIRMADO' &&
                        request.resource.data.diff(resource.data).affectedKeys()
                          .hasOnly(['status', 'signedDate', 'signatureUrl']));
      allow delete: if isAdmin();
    }

    match /document_templates/{templateId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /vehicles/{vehicleId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /warehouses/{warehouseId} {
      allow read: if isAuth();
      allow create, delete: if isAdmin();
      allow update: if isAdmin();

      match /stock/{stockItemId} {
        allow read: if isAuth();
        allow write: if isAdmin();
      }
    }

    match /materials/{materialId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /inventory_items/{itemId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /messages/{messageId} {
      allow read: if request.auth != null &&
                     (request.auth.uid in resource.data.recipientIds ||
                      request.auth.uid == resource.data.senderId);
      allow write: if request.auth != null;
    }

    match /expense_reports/{reportId} {
      allow read: if isAdmin() ||
                     (isWorker() && resource.data.workerId == request.auth.uid);
      allow list: if isAuth();
      allow create: if isWorker() &&
                       request.resource.data.workerId == request.auth.uid &&
                       request.resource.data.status == 'DRAFT' &&
                       request.resource.data.items is list &&
                       request.resource.data.totalAmount is number &&
                       request.resource.data.totalAmount >= 0;
      allow update: if (isWorker() &&
                         resource.data.workerId == request.auth.uid &&
                         (
                           (resource.data.status == 'DRAFT' &&
                            request.resource.data.status in ['DRAFT', 'SUBMITTED']) ||
                           (resource.data.status == 'DRAFT' &&
                            request.resource.data.status == 'SUBMITTED')
                         ) &&
                         request.resource.data.workerId == resource.data.workerId)
                       ||
                       (isAdmin() &&
                         request.resource.data.workerId == resource.data.workerId &&
                         request.resource.data.items == resource.data.items &&
                         request.resource.data.totalAmount == resource.data.totalAmount &&
                         resource.data.status == 'SUBMITTED' &&
                         request.resource.data.status in ['APPROVED', 'REJECTED']);
      allow delete: if isWorker() &&
                       resource.data.workerId == request.auth.uid &&
                       resource.data.status == 'DRAFT';
    }

    // --- COLECCI칍N: notifications ---
    match /notifications/{notificationId} {
      // Lectura: Solo el usuario due침o puede leer sus notificaciones
      allow read: if isAuth() && resource.data.userId == request.auth.uid;
      allow list: if isAuth();

      // Crear: Cualquier usuario autenticado puede crear (para FCM Service)
      allow create: if isAuth();

      // Actualizar: Solo el due침o puede marcar como le칤da
      allow update: if isAuth() && resource.data.userId == request.auth.uid;

      // Borrar: Solo el due침o puede borrar
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }

    // 游 Por defecto TODO se deniega
  }
}